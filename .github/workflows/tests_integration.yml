name: Test on Deploy

permissions:
    contents: read

on:
  workflow_call:
    inputs:
      git-sha:
        required: false
        type: string
        default: ""
      deploy-env:
        required: true
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true
  workflow_dispatch:
    inputs:
      git-sha:
        required: false
        type: string
        default: ""
      deploy-env:
        required: true
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true

defaults:
  run:
    shell: bash

env:
  UV_LINK_MODE: "symlink"

jobs:
  # Run our integration tests
  test:
    environment:
      name: ${{ inputs.deploy-env }}
      url: ${{ vars.MDB_ENV_URL }}
    name: Run integration tests on deploy
    runs-on: mdb-dev
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.git-sha }}
    - name: Setup uv
      uses: astral-sh/setup-uv@v5
      with:
        # Place cache in the tool dir because we mount this in our runnners
        cache-local-path: "/home/runner/_work/_tool/uv-local-cache"
        prune-cache: false
        python-version: ${{ vars.CI_PYTHON_VERSION || '3.11' }}
    - name: Install dependencies
      run: |
        uv pip install -r requirements/requirements-test.txt
    - name: Reset MindsDB auto config
      shell: bash
      run: |
        python - <<'PY'
        import json
        import os
        import sys
        from pathlib import Path
        from mindsdb.utilities.config import Config


        def add_candidate(paths, value):
            if not value:
                return
            normalized = str(Path(value).expanduser())
            if normalized not in paths:
                paths.append(normalized)


        def collect_roots():
            roots = []
            add_candidate(roots, os.environ.get("MINDSDB_STORAGE_DIR"))
            add_candidate(roots, Path.home() / ".local" / "share" / "mindsdb" / "mindsdb" / "var")

            workspace = os.environ.get("GITHUB_WORKSPACE")
            if workspace:
                add_candidate(roots, Path(workspace) / "var")

            docker_config = Path("docker/mindsdb_config.release.json")
            if docker_config.is_file():
                try:
                    docker_root = json.loads(docker_config.read_text()).get("paths", {}).get("root")
                    add_candidate(roots, docker_root)
                except Exception as exc:
                    print(f"Warning: could not parse {docker_config}: {exc}")

            add_candidate(roots, "/mindsdb/var")
            add_candidate(roots, "/root/mdb_storage")

            return roots


        def disable_http_auth(root):
            print(f"Ensuring HTTP auth disabled for storage root: {root}")
            try:
                Config._Config__instance = None
                os.environ["MINDSDB_STORAGE_DIR"] = root
                Path(root).mkdir(parents=True, exist_ok=True)
                Config().update({"auth": {"http_auth_enabled": False}}, overwrite=True)
                print(f"HTTP auth disabled for storage root: {root}")
                return True
            except PermissionError as exc:
                print(f"Skipping {root} due to permission error: {exc}")
                return False
            except Exception as exc:
                print(f"Failed to disable auth for {root}: {exc}")
                return False


        any_success = False
        for candidate_root in collect_roots():
            result = disable_http_auth(candidate_root)
            any_success = any_success or result

        if not any_success:
            print("Failed to disable HTTP auth for all candidate storage roots")
            sys.exit(1)
        PY


    - name: Run Integration Tests on Deploy
      run: |
          make integration_tests_slow
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        INTERNAL_URL: ${{ vars.MINDSDB_INTERNAL_URL }}
