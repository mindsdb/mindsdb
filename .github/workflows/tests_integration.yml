name: Test on Deploy

permissions:
    contents: read

on:
  workflow_call:
    inputs:
      git-sha:
        required: false
        type: string
        default: ""
      deploy-env:
        required: true
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true
  workflow_dispatch:
    inputs:
      git-sha:
        required: false
        type: string
        default: ""
      deploy-env:
        required: true
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true

defaults:
  run:
    shell: bash

env:
  UV_LINK_MODE: "symlink"

jobs:
  # Run our integration tests
  test:
    environment:
      name: ${{ inputs.deploy-env }}
      url: ${{ vars.MDB_ENV_URL }}
    name: Run integration tests on deploy
    runs-on: mdb-dev
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.git-sha }}
    - name: Setup uv
      uses: astral-sh/setup-uv@v5
      with:
        # Place cache in the tool dir because we mount this in our runnners
        cache-local-path: "/home/runner/_work/_tool/uv-local-cache"
        prune-cache: false
        python-version: ${{ vars.CI_PYTHON_VERSION || '3.11' }}
    - name: Install dependencies
      run: |
        uv pip install -r requirements/requirements-test.txt
    - name: Reset MindsDB auto config
      shell: bash
      run: |
        python - <<'PY'
        import os
        import sys
        from pathlib import Path
        from mindsdb.utilities.config import Config

        roots = []

        env_root = os.environ.get("MINDSDB_STORAGE_DIR")
        if env_root:
            roots.append(env_root)

        home_root = Path.home() / ".local" / "share" / "mindsdb" / "mindsdb" / "var"
        roots.append(str(home_root))

        workspace = os.environ.get("GITHUB_WORKSPACE")
        if workspace:
            roots.append(str(Path(workspace) / "var"))

        normalized = []
        seen = set()
        for root in roots:
            if not root:
                continue
            norm = str(Path(root).expanduser())
            if norm in seen:
                continue
            seen.add(norm)
            normalized.append(norm)

        success = False

        for root in normalized:
            try:
                # Ensure Config sees the new storage dir
                Config._Config__instance = None
                os.environ["MINDSDB_STORAGE_DIR"] = root

                Config().update({"auth": {"http_auth_enabled": False}}, overwrite=True)
                print(f"HTTP auth disabled for storage root: {root}")
                success = True
            except Exception as exc:
                print(f"Failed to disable auth for {root}: {exc}")

        if not success:
            print("Could not disable HTTP auth for any candidate storage root")
            sys.exit(1)
        PY


    - name: Run Integration Tests on Deploy
      run: |
          make integration_tests_slow
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        INTERNAL_URL: ${{ vars.MINDSDB_INTERNAL_URL }}
