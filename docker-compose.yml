services:

  # Auto-restarts containers that are unhealthy
  autoheal:
    container_name: autoheal
    image: willfarrell/autoheal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    <<: &autoRestartOnFailure
      deploy:
        restart_policy:
          condition: on-failure
          max_attempts: 10

  mindsdb:
    <<: *autoRestartOnFailure
    image: mindsdb/mindsdb:devel
    restart: always
    ports:
      - '47334:47334'
      - '47335:47335'
      - '47336:47336'
    environment:
      MINDSDB_DOCKER_ENV: "True"
      MINDSDB_STORAGE_DIR: "/mindsdb/var"
      FLASK_DEBUG: 1  # This will make sure http requests are logged regardless of log level
      MINDSDB_APIS: "http"  # Explicitly set the APIs to enable
      # OPENAI_API_KEY: "..."
    volumes:
      - type: bind
        source: .
        target: /mindsdb
    healthcheck:
      test:  ["CMD", "curl", "-f", "http://localhost:47334/api/util/ping"]
      interval: 30s
      timeout: 4s
      retries: 100

  frontend:
    platform: linux/amd64
    #image: 168681354662.dkr.ecr.us-east-1.amazonaws.com/mindsdb-frontend:latest
    build:
      context: mindsdb-frontend
    restart: always
    ports:
      - '3000:3000'
volumes:
  db_data:
    driver: local
